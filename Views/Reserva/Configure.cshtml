@model AeroTejo.ViewModels.ReservaConfigViewModel

<div class="container mt-5">
    <h2>Configurar Reserva</h2>

    <div class="card mb-4 bg-light">
        <div class="card-body">
            <h5>üõ´ Voo: @Model.Voo?.Companhia</h5>
            <p><strong>@Model.Voo?.Origem ‚ûù @Model.Voo?.Destino</strong> | @Model.Voo?.DataHora.ToString("dd/MM/yyyy HH:mm")</p>
        </div>
    </div>

    @if (!ViewData.ModelState.IsValid)
    {
    <div class="alert alert-danger">
        <div asp-validation-summary="All" class="text-danger"></div>
    </div>
    }

    <form asp-action="Configure" method="post">
        <input type="hidden" asp-for="VooId" />
        <input type="hidden" asp-for="HotelId" />

        @if (Model.HotelId.HasValue)
        {
        <div class="card mb-4 p-3 border-info">
            <h5 class="text-info">üè® Hotel: @Model.Hotel?.Nome</h5>
            <div class="row">
                <div class="col-md-6">
                    <label class="form-label">Check-in</label>
                    <input asp-for="DataCheckIn" class="form-control" type="date"
                           id="checkinDate"
                           min="@Model.Voo?.DataHora.ToString(" yyyy-MM-dd")" required />
                    <span asp-validation-for="DataCheckIn" class="text-danger"></span>
                </div>
                <div class="col-md-6">
                    <label class="form-label">Check-out</label>
                    <input asp-for="DataCheckOut" class="form-control" type="date"
                           id="checkoutDate"
                           min="@Model.Voo?.DataHora.AddDays(1).ToString(" yyyy-MM-dd")" required />
                    <span asp-validation-for="DataCheckOut" class="text-danger"></span>
                </div>
            </div>
            <small class="text-muted"><i class="bi bi-info-circle"></i> O check-in s√≥ pode ser feito a partir do dia de chegada do voo (@Model.Voo?.DataHora.ToShortDateString()).</small>
        </div>
        }

        <div class="mb-4">
            <h4>Passageiros & Assentos</h4>
            <div id="passageiros-container">
                @for (int i = 0; i < Model.Passageiros.Count; i++)
                {
                <div class="passageiro-row card mb-3 shadow-sm">
                    <div class="card-body">
                        <h6 class="card-title d-flex justify-content-between">
                            <span>Passageiro #<span class="p-num">@(i + 1)</span></span>
                            @if(i > 0) { <button type="button" class="btn btn-sm btn-outline-danger" onclick="removerPassageiro(this)">Remover</button> }
                        </h6>
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label class="form-label">Nome Completo</label>
                                <input name="Passageiros[@i].NomeCompleto" value="@Model.Passageiros[i].NomeCompleto" class="form-control" required />
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Documento</label>
                                <input name="Passageiros[@i].NumeroDocumento" value="@Model.Passageiros[i].NumeroDocumento" class="form-control" required />
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Assento</label>
                                <select name="Passageiros[@i].AssentoSelecionado" class="form-select seat-select" required>
                                    <option value="">-- Selecionar --</option>
                                    @foreach (var seat in Model.AssentosDisponiveis)
                                    {
                                        <!option value="@seat" @(Model.Passageiros[i].AssentoSelecionado == seat ? "selected" : "")>@seat</!option>
                                    }
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
                }
            </div>

            <button type="button" class="btn btn-secondary" onclick="adicionarPassageiro()">+ Adicionar Passageiro</button>
        </div>

        <button type="submit" class="btn btn-primary btn-lg w-100 mt-3">Seguir para Pagamento</button>
    </form>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        const checkinInput = document.getElementById('checkinDate');
        const checkoutInput = document.getElementById('checkoutDate');

        if (checkinInput && checkoutInput) {
            checkinInput.addEventListener('change', function () {
                if (!this.value) return;
                let dataCheckin = new Date(this.value);
                dataCheckin.setDate(dataCheckin.getDate() + 1);
                let minCheckout = dataCheckin.toISOString().split('T')[0];
                checkoutInput.min = minCheckout;
                if (checkoutInput.value && checkoutInput.value < minCheckout) {
                    checkoutInput.value = minCheckout;
                }
            });
        }

        function adicionarPassageiro() {
            var container = document.getElementById('passageiros-container');
            var index = container.querySelectorAll('.passageiro-row').length;
            var firstSelect = document.querySelector('.seat-select');
            var options = firstSelect ? firstSelect.innerHTML : '<option value="">-- Selecionar --</option>';

            var html = `
                    <div class="passageiro-row card mb-3 shadow-sm">
                        <div class="card-body">
                            <h6 class="card-title d-flex justify-content-between">
                                <span>Passageiro #<span class="p-num">${index + 1}</span></span>
                                <button type="button" class="btn btn-sm btn-outline-danger" onclick="removerPassageiro(this)">Remover</button>
                            </h6>
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <label class="form-label">Nome Completo</label>
                                    <input name="Passageiros[${index}].NomeCompleto" class="form-control" required />
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Documento</label>
                                    <input name="Passageiros[${index}].NumeroDocumento" class="form-control" required />
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Assento</label>
                                    <select name="Passageiros[${index}].AssentoSelecionado" class="form-select seat-select" required>
                                        ${options}
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>`;
            container.insertAdjacentHTML('beforeend', html);
        }

        function removerPassageiro(btn) {
            btn.closest('.passageiro-row').remove();
            document.querySelectorAll('.passageiro-row').forEach((row, idx) => {
                row.querySelector('.p-num').textContent = idx + 1;
                // Re-indexar nomes para o servidor receber a lista correta
                row.querySelectorAll('input, select').forEach(input => {
                    let name = input.getAttribute('name');
                    if (name) input.setAttribute('name', name.replace(/\[\d+\]/, '[' + idx + ']'));
                });
            });
        }
    </script>
}